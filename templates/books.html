{% extends 'base.html' %}
{% from 'macros.html' import page_header %}

{% block title %}Books{% endblock %}

{% block content %}

{% call page_header('Books', 'A collection of my reading list.') %}
    <button onclick="openAddBookModal()" class="btn-primary" style="padding: 8px 16px; border-radius: 20px; border: none; background: #3498db; color: white; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
        <i class="fa-solid fa-plus"></i> Add Book
    </button>
{% endcall %}

<style>
    .books-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 30px;
        margin-bottom: 50px;
    }
    .book-card {
        background: #fff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(0,0,0,0.03);
        position: relative;
        overflow: hidden;
    }
    .book-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }
    .book-cover {
        height: 200px;
        background: #f8f9fa;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: #bdc3c7;
        margin-bottom: 15px;
        overflow: hidden;
    }
    .book-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .book-info h3 {
        font-size: 1.1rem;
        margin: 0 0 5px 0;
        color: #2c3e50;
        font-weight: 600;
    }
    .book-info .author {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin: 0 0 15px 0;
    }
    .progress-container {
        margin-top: auto;
        padding-bottom: 10px; /* Add some space so overlay doesn't cover immediately if not hovering */
    }
    .progress-bar {
        height: 6px;
        background: #ecf0f1;
        border-radius: 3px;
        margin-bottom: 5px;
        overflow: hidden;
    }
    .progress {
        height: 100%;
        background: #3498db;
        border-radius: 3px;
    }
    .progress-text {
        font-size: 0.8rem;
        color: #95a5a6;
        display: flex;
        justify-content: space-between;
    }
    .empty-state {
        color: #95a5a6;
        font-style: italic;
        background: #f8f9fa;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        grid-column: 1 / -1;
    }
    .section-header {
        margin-bottom: 25px;
        border-bottom: 2px solid #f0f2f5;
        padding-bottom: 10px;
    }
    .section-header h2 {
        color: #2c3e50;
        font-size: 1.5rem;
        margin: 0;
    }
    .book-actions-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.98);
        padding: 15px;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
        border-top: 1px solid #f0f0f0;
        box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
    }
    .book-card:hover .book-actions-overlay {
        transform: translateY(0);
    }
</style>

<div class="books-container">
    
    <!-- 1. Currently Reading -->
    <div class="section-header">
        <h2>Currently Reading</h2>
    </div>
    <div class="books-grid">
        {% for book in currently_reading %}
        <div class="book-card">
            <div class="book-cover">
                <i class="fa-solid fa-book-open"></i>
            </div>
            <div class="book-info">
                <h3>{{ book.title }}</h3>
                <p class="author">{{ book.author }}</p>
                <div class="progress-container">
                    {% set percent = (book.current_page / book.total_pages * 100) | int if book.total_pages > 0 else 0 %}
                    <div class="progress-bar"><div class="progress" style="width: {{ percent }}%"></div></div>
                    <div class="progress-text">
                        <span>{{ percent }}%</span>
                        <span>{{ book.current_page }}/{{ book.total_pages }} pages</span>
                    </div>
                </div>
            </div>
            <div class="book-actions-overlay">
                <button onclick="updateProgress('{{ book._id }}', {{ book.current_page or 0 }}, {{ book.total_pages or 0 }})" class="btn-ghost" style="flex: 1; font-size: 0.8rem; padding: 8px; width: 100%;">Update</button>
                <form action="{{ url_for('books.update_book_status') }}" method="POST" style="display: inline;">
                    <input type="hidden" name="book_id" value="{{ book._id }}">
                    <input type="hidden" name="status" value="completed">
                    <button type="submit" title="Mark as Finished" style="background: none; border: none; color: #2ecc71; font-size: 1.1rem; cursor: pointer; padding: 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                        <i class="fa-solid fa-check"></i>
                    </button>
                </form>
                <form id="delete-form-{{ book._id }}" action="{{ url_for('books.delete_book') }}" method="POST" style="display: none;">
                    <input type="hidden" name="book_id" value="{{ book._id }}">
                </form>
                <button onclick="confirmDeleteBook('{{ book._id }}')" title="Delete Book" style="background: none; border: none; color: #e74c3c; font-size: 1.1rem; cursor: pointer; padding: 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fa-solid fa-book-open" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
            Not reading anything right now. Pick one from your list!
        </div>
        {% endfor %}
    </div>

    <!-- 2. Read in {{ now.year if now else '2026' }} -->
    <div class="section-header">
        <h2>Read in {{ now.year if now else '2026' }}</h2>
    </div>
    <div class="books-grid">
        {% for book in completed_books %}
        <div class="book-card">
            <div class="book-cover" style="background: #e8f8f5; color: #2ecc71;">
                <i class="fa-solid fa-check"></i>
            </div>
            <div class="book-info">
                <h3>{{ book.title }}</h3>
                <p class="author">{{ book.author }}</p>
            </div>
            <div class="book-actions-overlay">
                <form id="delete-form-{{ book._id }}" action="{{ url_for('books.delete_book') }}" method="POST" style="display: none;">
                    <input type="hidden" name="book_id" value="{{ book._id }}">
                </form>
                <button onclick="confirmDeleteBook('{{ book._id }}')" title="Delete Book" style="background: none; border: none; color: #e74c3c; font-size: 1.1rem; cursor: pointer; padding: 8px; transition: transform 0.2s; width: 100%;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fa-solid fa-book" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
            No books completed yet this year. Keep reading!
        </div>
        {% endfor %}
    </div>

    <!-- 3. To Read (Wishlist) -->
    <div class="section-header">
        <h2>To Read</h2>
    </div>
    <div class="books-grid">
        {% for book in to_read %}
        <div class="book-card">
            <div class="book-cover">
                <i class="fa-solid fa-bookmark"></i>
            </div>
            <div class="book-info">
                <h3>{{ book.title }}</h3>
                <p class="author">{{ book.author }}</p>
            </div>
            <div class="book-actions-overlay">
                <button onclick="startReading('{{ book._id }}', {{ book.total_pages or 0 }})" class="btn-ghost" style="flex: 1; font-size: 0.8rem; padding: 8px; width: 100%;">Start Reading</button>
                <form id="delete-form-{{ book._id }}" action="{{ url_for('books.delete_book') }}" method="POST" style="display: none;">
                    <input type="hidden" name="book_id" value="{{ book._id }}">
                </form>
                <button onclick="confirmDeleteBook('{{ book._id }}')" style="background: none; border: none; color: #e74c3c; font-size: 1.1rem; cursor: pointer; padding: 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fa-solid fa-list" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
            Your reading list is empty. Add some books!
        </div>
        {% endfor %}
    </div>

</div>

<!-- Add Book Modal -->
<div class="modal-overlay" id="addBookModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Book</h3>
            <button onclick="closeAddBookModal()" class="modal-close-btn">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <form action="{{ url_for('books.add_book') }}" method="POST">
            <div class="modal-form-group">
                <label class="modal-form-label">Book Title</label>
                <input type="text" name="title" required placeholder="e.g. Atomic Habits" class="modal-form-input">
            </div>
            
            <div class="modal-form-group">
                <label class="modal-form-label">Author</label>
                <input type="text" name="author" placeholder="e.g. James Clear" class="modal-form-input">
            </div>
            
            <!-- Hidden status field defaulting to 'to_read' -->
            <input type="hidden" name="status" value="to_read">

            <div class="modal-actions">
                <button type="button" onclick="closeAddBookModal()" class="btn-modal-cancel">
                    Cancel
                </button>
                <button type="submit" class="btn-modal-submit">
                    Add to Library
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Start Reading Modal -->
<div class="modal-overlay" id="startReadingModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Start Reading</h3>
            <button type="button" onclick="closeBookModal('startReadingModal')" class="modal-close-btn">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <form action="{{ url_for('books.update_book_status') }}" method="POST">
            <input type="hidden" name="book_id" id="startReadingBookId">
            <input type="hidden" name="status" value="reading">
            
            <div class="modal-form-group">
                <label class="modal-form-label">Total Pages</label>
                <input type="number" name="total_pages" id="startReadingTotalPages" required min="1" class="modal-form-input">
                <p class="modal-form-help">Enter the total number of pages to track your progress.</p>
            </div>

            <div class="modal-actions">
                <button type="button" onclick="closeBookModal('startReadingModal')" class="btn-modal-cancel">
                    Cancel
                </button>
                <button type="submit" class="btn-modal-submit">
                    Start Journey
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Update Progress Modal -->
<div class="modal-overlay" id="updateProgressModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Update Progress</h3>
            <button type="button" onclick="closeBookModal('updateProgressModal')" class="modal-close-btn">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <form action="{{ url_for('books.update_book_progress') }}" method="POST">
            <input type="hidden" name="book_id" id="updateProgressBookId">
            
            <div id="totalPagesField" class="modal-form-group" style="display: none;">
                <label class="modal-form-label">Total Pages</label>
                <input type="number" name="total_pages" id="updateProgressTotalPages" min="1" class="modal-form-input">
            </div>

            <div class="modal-form-group">
                <label class="modal-form-label">Current Page</label>
                <input type="number" name="current_page" id="updateProgressCurrentPage" required min="0" class="modal-form-input">
            </div>

            <div class="modal-actions">
                <button type="button" onclick="closeBookModal('updateProgressModal')" class="btn-modal-cancel">
                    Cancel
                </button>
                <button type="submit" class="btn-modal-submit">
                    Update
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function openAddBookModal() {
        document.getElementById('addBookModal').classList.add('active');
    }

    function closeAddBookModal() {
        document.getElementById('addBookModal').classList.remove('active');
    }
    
    function closeBookModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function confirmDeleteBook(bookId) {
        showConfirm("Are you sure you want to delete this book?", function() {
            document.getElementById('delete-form-' + bookId).submit();
        });
    }

    function startReading(bookId, currentTotalPages) {
        // If we already have total pages, just submit directly
        if (currentTotalPages && currentTotalPages > 0) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('books.update_book_status') }}";
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'book_id';
            idInput.value = bookId;
            
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = 'reading';
            
            form.appendChild(idInput);
            form.appendChild(statusInput);
            document.body.appendChild(form);
            form.submit();
        } else {
            // Otherwise open modal to ask for pages
            document.getElementById('startReadingBookId').value = bookId;
            document.getElementById('startReadingTotalPages').value = '';
            document.getElementById('startReadingModal').classList.add('active');
        }
    }

    function updateProgress(bookId, currentPage, totalPages) {
        document.getElementById('updateProgressBookId').value = bookId;
        document.getElementById('updateProgressCurrentPage').value = currentPage;
        
        const totalPagesField = document.getElementById('totalPagesField');
        const totalPagesInput = document.getElementById('updateProgressTotalPages');
        
        if (!totalPages || totalPages == 0) {
            totalPagesField.style.display = 'block';
            totalPagesInput.required = true;
            totalPagesInput.value = '';
        } else {
            totalPagesField.style.display = 'none';
            totalPagesInput.required = false;
        }
        
        document.getElementById('updateProgressModal').classList.add('active');
    }

    // Close modals on outside click
    window.onclick = function(event) {
        if (event.target.classList.contains('modal-overlay')) {
            event.target.classList.remove('active');
        }
    }
</script>
{% endblock %}

