{% extends 'base.html' %}
{% from 'macros.html' import page_header %}

{% block title %}Reminders{% endblock %}

{% block content %}
<style>
    /* Custom Tooltip (reusing class from style.css but ensuring visibility) */
    .custom-tooltip {
        z-index: 10000; /* Ensure it's on top */
    }
</style>

{{ page_header('Reminders', 'Never forget a task.') }}

<div class="habit-container">

    <!-- Today's Reminders -->
    <div class="section-header">
        <h2>Today's Reminders</h2>
        <span style="font-size: 0.9rem; color: #7f8c8d;">{{ today_date }}</span>
    </div>

    <div class="habit-list" style="margin-bottom: 40px;">
        {% if todays_reminders %}
            {% for r in todays_reminders %}
            <div class="habit-list-item" style="border-left: 4px solid #2ecc71;">
                <div class="habit-info-row" style="display: flex; align-items: center; gap: 20px;">
                    <span class="habit-name" style="font-size: 1.1rem; font-weight: 600;">{{ r.title }}</span>
                    {% if r.recurrence == 'yearly' %}
                    <span class="suggestion-tag active">Yearly</span>
                    {% endif %}
                </div>
                <div class="habit-meta" style="display: flex; align-items: center; gap: 10px;">
                    <button onclick="confirmDelete('{{ r._id }}', '{{ r.title }}', '{{ r.recurrence }}', '{{ r.date }}')" class="delete-btn" style="color: #2ecc71; border-color: #2ecc71;">
                        <i class="fa-solid fa-check"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="color: #999; font-style: italic;">No reminders for today.</p>
        {% endif %}
    </div>
    
    <!-- Upcoming Reminders List -->
    <div class="section-header">
        <h2>Upcoming Reminders</h2>
    </div>
    
    <div class="habit-list" id="reminderList">
        {% if upcoming_reminders %}
            {% for r in upcoming_reminders %}
            <div class="habit-list-item" id="reminder-{{ r.original_id if r.original_id else r._id }}">
                <div class="habit-info-row" style="display: flex; align-items: center; gap: 15px;">
                    <span class="habit-name" style="font-size: 1.1rem; font-weight: 600;">{{ r.title }}</span>
                    <span class="suggestion-tag" style="font-size: 0.95rem; background: #eef2ff; color: #333;">{{ r.date }}</span>
                    {% if r.recurrence == 'yearly' %}
                    <span class="suggestion-tag active">Yearly</span>
                    {% endif %}
                    {% if r.remind_days_before %}
                    <span class="suggestion-tag" style="background:#fff3cd; color:#856404; font-size: 0.95rem;">{{ r.remind_days_before }}d before</span>
                    {% endif %}
                </div>
                <div class="habit-meta">
                    <button onclick="confirmDelete('{{ r.original_id if r.original_id else r._id }}', '{{ r.title }}', '{{ r.recurrence }}', '{{ r.date }}')" class="delete-btn">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p id="noRemindersMsg" style="color: #999; font-style: italic;">No upcoming reminders.</p>
        {% endif %}
    </div>

    <!-- Calendar View -->
    <div class="insights-wrapper" style="margin-top: 40px;">
        <div class="controls-header" style="justify-content: space-between; border-bottom: none; padding-bottom: 0; margin-bottom: 15px;">
            <h2 style="margin: 0; font-size: 1.1rem; color: #333;">Yearly Overview</h2>
            <div class="year-nav">
                <a href="{{ url_for('reminder', year=selected_year-1) }}"><i class="fa-solid fa-chevron-left"></i></a>
                <span class="year-display">{{ selected_year }}</span>
                <a href="{{ url_for('reminder', year=selected_year+1) }}"><i class="fa-solid fa-chevron-right"></i></a>
            </div>
        </div>
        
        <div class="heatmap-container">
            <div class="heatmap-labels">
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
                <div>Sun</div>
            </div>
            
            <div class="months-row">
                {% for month in months_data %}
                <div class="month-block">
                    <div class="month-name">{{ month.name }}</div>
                    <div class="heatmap-grid">
                        {% for day in month.days %}
                            {% if day is none %}
                                <div class="heatmap-cell empty" style="visibility:hidden;"></div>
                            {% else %}
                                <div class="heatmap-cell {{ 'today' if day.date == today_date else '' }}"
                                     style="background-color: rgba(46, 204, 113, {{ 0.2 + (day.count * 0.2) if day.count > 0 else 0 }}); {{ 'background-color: #f0f2f5;' if day.count == 0 else '' }}"
                                     {% if day.reminders %}
                                     data-tooltip="{{ day.display_date }}: {{ day.reminders | map(attribute='title') | join(', ') }}"
                                     {% else %}
                                     data-tooltip="{{ day.display_date }}: No events"
                                     {% endif %}>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Manage Reminders Section (Moved to Bottom) -->
    <div class="manage-container" style="margin-top: 40px;">
        <div class="manage-header" onclick="toggleManage()">
            <h3>Add Reminder</h3>
            <i class="fa-solid fa-chevron-down" id="toggleIcon"></i>
        </div>
        <div class="manage-content" id="manageContent">
            <div class="add-form" style="border:none; padding:0; box-shadow:none; margin-top:0;">
                <div class="add-habit-wrapper" style="flex-wrap: wrap; align-items: flex-start;">
                    <div style="flex: 2; min-width: 200px;">
                        <input type="text" id="reminderTitle" placeholder="Event Title" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <input type="date" id="reminderDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <select id="reminderRecurrence" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="">One-time</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 150px; display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="reminderDays" placeholder="Days before" style="width: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <button type="button" onclick="addReminder()" class="btn-primary" style="white-space: nowrap;">Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="custom-tooltip"></div>

    <!-- Custom Modal for Recurring Deletion -->
    <div class="modal-overlay" id="recurringDeleteModal">
        <div class="modal-content">
            <h3>Delete Recurring Reminder</h3>
            <p>Do you want to delete this specific occurrence or the entire series?</p>
            <div class="modal-actions" style="flex-direction: column; gap: 10px;">
                <button class="btn-primary" onclick="confirmRecurringDelete('instance')" style="width: 100%;">Delete This Occurrence Only</button>
                <button class="btn-ghost" onclick="confirmRecurringDelete('series')" style="width: 100%; color: var(--danger-red); border-color: var(--danger-red);">Delete Entire Series</button>
                <button class="btn-ghost" onclick="closeRecurringModal()" style="width: 100%;">Cancel</button>
            </div>
        </div>
    </div>

</div>

<script>
    let pendingDeleteId = null;
    let pendingDeleteDate = null;

    function toggleManage() {
        const content = document.getElementById('manageContent');
        const icon = document.getElementById('toggleIcon');
        content.classList.toggle('open');
        icon.classList.toggle('fa-chevron-up');
        icon.classList.toggle('fa-chevron-down');
    }

    async function addReminder() {
        const title = document.getElementById('reminderTitle').value;
        const date = document.getElementById('reminderDate').value;
        const recurrence = document.getElementById('reminderRecurrence').value;
        const days = document.getElementById('reminderDays').value;

        if (!title || !date) {
            alert('Please enter a title and date');
            return;
        }

        const formData = new FormData();
        formData.append('title', title);
        formData.append('date', date);
        formData.append('recurrence', recurrence);
        if (days) formData.append('remind_days', days);

        try {
            const response = await fetch("{{ url_for('add_reminder') }}", {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            if (data.status === 'success') {
                // Clear inputs
                document.getElementById('reminderTitle').value = '';
                document.getElementById('reminderDate').value = '';
                document.getElementById('reminderDays').value = '';
                
                // Add to list
                createReminderItem(data);
                
                // Hide 'no reminders' message
                const msg = document.getElementById('noRemindersMsg');
                if (msg) msg.style.display = 'none';
            }
        } catch (e) {
            console.error(e);
            location.reload();
        }
    }

    function createReminderItem(data) {
        const list = document.getElementById('reminderList');
        const div = document.createElement('div');
        div.className = 'habit-list-item';
        div.id = `reminder-${data.id}`;
        
        let tags = `<span class="suggestion-tag">${data.date}</span>`;
        if (data.recurrence === 'yearly') {
            tags += `<span class="suggestion-tag active">Yearly</span>`;
        }
        
        div.innerHTML = `
            <div class="habit-info-row" style="display: flex; align-items: center; gap: 15px;">
                <span class="habit-name">${data.title}</span>
                ${tags}
            </div>
            <div class="habit-meta">
                <button onclick="confirmDelete('${data.id}', '${data.title}', '${data.recurrence}', '${data.date}')" class="delete-btn">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        `;
        list.prepend(div);
    }

    function confirmDelete(id, title, recurrence, date) {
        if (recurrence === 'yearly') {
            pendingDeleteId = id;
            pendingDeleteDate = date;
            const modal = document.getElementById('recurringDeleteModal');
            modal.classList.add('active');
        } else {
            showConfirm(`Delete reminder '${title}'?`, () => deleteReminder(id, 'series'));
        }
    }

    // Set up click-outside-to-close for recurring modal ONCE
    document.addEventListener('DOMContentLoaded', function() {
        const recurringModal = document.getElementById('recurringDeleteModal');
        if (recurringModal) {
            recurringModal.addEventListener('click', function(e) {
                if (e.target === recurringModal) closeRecurringModal();
            });
        }
    });

    function closeRecurringModal() {
        const modal = document.getElementById('recurringDeleteModal');
        modal.classList.remove('active');
        pendingDeleteId = null;
        pendingDeleteDate = null;
    }

    function confirmRecurringDelete(mode) {
        if (pendingDeleteId) {
            deleteReminder(pendingDeleteId, mode, pendingDeleteDate);
            closeRecurringModal();
        }
    }

    async function deleteReminder(id, mode, date = null) {
        const formData = new FormData();
        formData.append('id', id);
        formData.append('mode', mode);
        if (date) formData.append('date', date);
        
        try {
            const response = await fetch("{{ url_for('delete_reminder') }}", {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            if (data.status === 'success') {
                const el = document.getElementById(`reminder-${id}`);
                if (el) el.remove();
                
                // Check if empty
                const list = document.getElementById('reminderList');
                if (list.children.length === 0 || (list.children.length === 1 && list.children[0].id === 'noRemindersMsg')) {
                    const msg = document.getElementById('noRemindersMsg');
                    if (msg) msg.style.display = 'block';
                    else list.innerHTML = '<p id="noRemindersMsg" style="color: #999; font-style: italic;">No upcoming reminders.</p>';
                }
            }
        } catch (e) {
            console.error(e);
            location.reload();
        }
    }

    // Tooltip Logic (Shared with Habits)
    const tooltip = document.getElementById('tooltip');
    const cells = document.querySelectorAll('.heatmap-cell');

    cells.forEach(cell => {
        cell.addEventListener('mouseenter', (e) => {
            const text = cell.getAttribute('data-tooltip');
            if (text) {
                tooltip.textContent = text;
                tooltip.style.display = 'block';
                positionTooltip(e);
            }
        });

        cell.addEventListener('mousemove', (e) => {
            positionTooltip(e);
        });

        cell.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
        });
    });

    function positionTooltip(e) {
        const x = e.pageX + 10;
        const y = e.pageY + 10;
        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
    }
</script>
{% endblock %}
